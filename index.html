<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Many Circles | Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„ 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #f1f5f9; 
            overflow-x: hidden; 
        }
        .admin-page { 
            background-color: #ffffff; 
            min-height: 100vh; 
            width: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
            padding: 20px; 
            z-index: 50; 
        }
        .hidden { display: none !important; }
        .card-hover { 
            transition: 0.3s; 
            cursor: pointer; 
            border-radius: 2rem; 
            border: 2px solid #f1f5f9; 
            position: relative; 
        }
        .card-hover:hover { 
            transform: translateY(-3px); 
            border-color: #3b82f6; 
        }
        .del-btn { 
            position: absolute; 
            top: -10px; 
            left: -10px; 
            background: #ef4444; 
            color: white; 
            width: 25px; 
            height: 25px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
            border: 2px solid white; 
            cursor: pointer; 
            z-index: 20; 
        }
        .section-title { 
            font-weight: 900; 
            color: #1e293b; 
            border-right: 5px solid #3b82f6; 
            padding-right: 10px; 
            margin-bottom: 15px; 
            margin-top: 20px; 
            text-align: right; 
        }
        .follow-up-box { 
            background: #fff; 
            border: 2px solid #e2e8f0; 
            border-radius: 1.5rem; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        .mood-btn { 
            font-size: 2.5rem; 
            filter: grayscale(1); 
            transition: 0.3s; 
            cursor: pointer; 
            opacity: 0.4; 
        }
        .mood-btn.active { 
            filter: grayscale(0); 
            transform: scale(1.2); 
            opacity: 1; 
        }
        .input-style { 
            width: 100%; 
            padding: 12px; 
            border-radius: 12px; 
            border: 1px solid #cbd5e1; 
            outline: none; 
            margin-bottom: 8px; 
            font-size: 14px; 
            font-weight: bold; 
            text-align: center; 
        }
        .goal-card { 
            background: #fff; 
            padding: 15px; 
            border-radius: 1.5rem; 
            border: 1px solid #e2e8f0; 
            margin-bottom: 10px; 
            border-right: 5px solid #f97316; 
        }
        @keyframes pulse-yellow {
            0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(250, 204, 21, 0); }
            100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
        }
        .today-pulse { animation: pulse-yellow 2s infinite; }
        
        .toast {
            animation: slideIn 0.5s ease-out forwards;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-fade-out {
            animation: slideOut 0.5s ease-in forwards;
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .btn-back {
            background: #ef4444 !important;
            color: white !important;
            padding: 12px 25px !important;
            border-radius: 50px !important;
            font-weight: bold !important;
            font-size: 16px !important;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
            border: none !important;
            display: block;
            margin-bottom: 20px;
            width: fit-content;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #fcc;
            margin: 10px 0;
        }
        
        .success-message {
            background: #efe;
            color: #2a7;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #cfc;
            margin: 10px 0;
        }
        
        .login-container {
            background: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 90%;
        }
        
        .main-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .role-card {
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 15px;
            border: 2px solid transparent;
            background: white;
        }
        
        .role-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #3b82f6;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù„Ù„Ø´Ù‡ÙˆØ± */
        .month-card {
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 25px;
            border-radius: 20px;
            margin: 10px;
            text-align: center;
            font-weight: bold;
            border: 3px solid transparent;
        }
        
        .month-card.current {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            transform: scale(1.05);
        }
        
        .month-card.past {
            background: #f3f4f6;
            color: #9ca3af;
        }
        
        .month-card.future {
            background: white;
            color: #1f2937;
            border-color: #e5e7eb;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ */
        .subject-card {
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 30px 20px;
            border-radius: 20px;
            margin: 15px;
            text-align: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .subject-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© */
        .day-card {
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 20px;
            border-radius: 15px;
            margin: 8px;
            text-align: center;
            font-weight: bold;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .day-card.today {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            transform: scale(1.1);
        }
        
        .day-card.has-report {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .day-card.no-report {
            background: #f3f4f6;
            color: #9ca3af;
        }
        
        .day-card.future {
            background: white;
            color: #1f2937;
            border: 2px solid #e5e7eb;
        }
        
        .activity-check {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body>
<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div id="mainScreen" class="main-screen">
    <div class="login-container text-center">
        <div class="mb-10">
            <div class="w-24 h-24 mx-auto bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center shadow-2xl mb-6">
                <span class="text-white text-2xl font-black">MC</span>
            </div>
            <h1 class="text-3xl font-black text-slate-800 mb-2">Many Circles</h1>
            <p class="text-slate-500">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</p>
        </div>
        
        <div class="space-y-4">
            <div onclick="openLogin('admin')" class="role-card">
                <div class="text-4xl mb-3">ğŸ’¼</div>
                <h3 class="text-xl font-bold text-blue-600 mb-1">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                <p class="text-sm text-slate-500">Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</p>
            </div>
            
            <div onclick="openLogin('teacher')" class="role-card">
                <div class="text-4xl mb-3">ğŸ‘©â€ğŸ«</div>
                <h3 class="text-xl font-bold text-emerald-600 mb-1">Ù…Ø¹Ù„Ù…Ø©</h3>
                <p class="text-sm text-slate-500">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
            </div>
            
            <div onclick="openLogin('parent')" class="role-card">
                <div class="text-4xl mb-3">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
                <h3 class="text-xl font-bold text-amber-600 mb-1">ÙˆÙ„ÙŠ Ø£Ù…Ø±</h3>
                <p class="text-sm text-slate-500">Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØªØ·ÙˆØ± Ø§Ù„Ø·ÙÙ„</p>
            </div>
        </div>
        
        <div class="mt-10 text-sm text-slate-400">
            Â© 2026 Many Circles. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginScreen" class="admin-page hidden">
    <div class="flex justify-center items-center min-h-screen">
        <div class="login-container">
            <button onclick="goBackToMain()" class="text-blue-600 font-bold mb-6 float-right">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            <h2 id="loginTitle" class="text-xl font-black mb-8 text-slate-700 text-center">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h2>
            <input type="text" id="loginName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="input-style bg-slate-50 mb-4" autocomplete="username">
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="input-style bg-slate-50 mb-6" autocomplete="current-password">
            <button id="loginBtn" class="w-full p-4 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 transition">
                Ø¯Ø®ÙˆÙ„
            </button>
            <div id="loginError" class="error-message hidden mt-4"></div>
            <div class="mt-6 text-sm text-slate-400 text-center">
                Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
            </div>
        </div>
    </div>
</div>

<!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
<div id="dashboard" class="admin-page hidden bg-slate-50 text-center">
    <div class="max-w-6xl mx-auto py-8 px-4">
        <h2 class="text-3xl font-black mb-6 text-slate-800">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
        <p class="text-slate-600 mb-10">Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="adminName"></span></p>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 px-4">
            <div onclick="openStudentsSection()" class="bg-white p-10 rounded-[2.5rem] shadow-xl border-b-8 border-blue-500 cursor-pointer hover:scale-105 transition">
                <div class="text-6xl mb-4">ğŸ‘¶</div>
                <h3 class="text-2xl font-black text-blue-600">Ø§Ù„Ø£Ø·ÙØ§Ù„</h3>
                <p class="text-slate-500 mt-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</p>
            </div>
            
            <div onclick="openTeachersSection()" class="bg-white p-10 rounded-[2.5rem] shadow-xl border-b-8 border-emerald-500 cursor-pointer hover:scale-105 transition">
                <div class="text-6xl mb-4">ğŸ‘©â€ğŸ«</div>
                <h3 class="text-2xl font-black text-emerald-600">Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª</h3>
                <p class="text-slate-500 mt-2">Ø¥Ø¯Ø§Ø±Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª</p>
            </div>
            
            <div onclick="openParentsSection()" class="bg-white p-10 rounded-[2.5rem] shadow-xl border-b-8 border-indigo-500 cursor-pointer hover:scale-105 transition">
                <div class="text-6xl mb-4">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
                <h3 class="text-2xl font-black text-indigo-600">Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</h3>
                <p class="text-slate-500 mt-2">Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡</p>
            </div>
        </div>
        
        <button onclick="logout()" class="mt-12 px-6 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition">
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </button>
    </div>
</div>

<!-- Ø¨Ù‚ÙŠØ© Ø§Ù„ØµÙØ­Ø§Øª Ø³ØªÙ†Ø´Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
<!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<div id="toastContainer" class="fixed bottom-5 right-5 z-[200] space-y-3"></div>

<script>
// ===================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© =====================
const firebaseConfig = {
    apiKey: "AIzaSyC4K55wOZy3w44cCNX1i_cmk4-g4P-L40",
    authDomain: "many-circles.firebaseapp.com",
    databaseURL: "https://many-circles-default-rtdb.firebaseio.com",
    projectId: "many-circles",
    storageBucket: "many-circles.firebasestorage.app",
    messagingSenderId: "905475370717",
    appId: "1:905475370717:web:587b788750f31a1d26f534"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =====================
const MASTER_CODE = "2012";
const ADMINS = ["Ø­Ø³Ù†","Ø¹Ù„ÙŠØ§Ø¡","Ù…ØµØ·ÙÙ‰","Ø­Ù†Ø§Ù†"];
const monthsArr = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
const activitiesList = ["Montessori", "Garden", "Colouring", "Art", "Swimming", "Puzzle", "Moral Values", "Songs", "Etiquette", "Circle Time", "Dancing", "P.E"];

let sId = "", sName = "", mName = "", currentSub = "", selectedMood = "", selectedDay = 0;
let currentLoginType = "";
let linkedStudentIdOfParent = "";
let editingGoalId = null;

// ===================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© =====================
function openLogin(type) {
    currentLoginType = type;
    mainScreen.classList.add('hidden');
    loginScreen.classList.remove('hidden');
    
    const titles = {
        'admin': { title: "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ğŸ‘‘", color: "#2563eb" },
        'teacher': { title: "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª ğŸ‘©â€ğŸ«", color: "#059669" },
        'parent': { title: "Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± ğŸ‘¨â€ğŸ‘©â€ğŸ‘§", color: "#4f46e5" }
    };
    
    const config = titles[type];
    loginTitle.innerText = config.title;
    loginBtn.style.backgroundColor = config.color;
    
    document.getElementById('loginError').classList.add('hidden');
    document.getElementById('loginName').value = '';
    document.getElementById('loginPass').value = '';
    document.getElementById('loginName').focus();
}

function goBackToMain() {
    loginScreen.classList.add('hidden');
    mainScreen.classList.remove('hidden');
}

// ===================== Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====================
document.getElementById('loginBtn').addEventListener('click', handleLogin);
document.getElementById('loginPass').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') handleLogin(e);
});

function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('loginName').value.trim();
    const password = document.getElementById('loginPass').value.trim();
    const errorDiv = document.getElementById('loginError');
    
    if (!username || !password) {
        errorDiv.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±";
        errorDiv.classList.remove('hidden');
        return;
    }
    
    const loginBtn = document.getElementById('loginBtn');
    const originalText = loginBtn.textContent;
    loginBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
    loginBtn.disabled = true;
    
    if (currentLoginType === 'admin') {
        handleAdminLogin(username, password, errorDiv, loginBtn, originalText);
    } else if (currentLoginType === 'teacher') {
        handleTeacherLogin(username, password, errorDiv, loginBtn, originalText);
    } else if (currentLoginType === 'parent') {
        handleParentLogin(username, password, errorDiv, loginBtn, originalText);
    }
}

function handleAdminLogin(username, password, errorDiv, loginBtn, originalText) {
    if (ADMINS.includes(username) && password === MASTER_CODE) {
        sessionStorage.setItem('adminUser', username);
        sessionStorage.setItem('loginType', 'admin');
        
        loginScreen.classList.add('hidden');
        dashboard.classList.remove('hidden');
        document.getElementById('adminName').textContent = username;
        showToast("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ " + username);
    } else {
        errorDiv.textContent = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
        errorDiv.classList.remove('hidden');
        loginBtn.textContent = originalText;
        loginBtn.disabled = false;
    }
}

function handleTeacherLogin(username, password, errorDiv, loginBtn, originalText) {
    db.ref('Teachers').once('value')
        .then(snap => {
            let found = false;
            snap.forEach(t => {
                const data = t.val();
                if (data.name === username && data.password === password) {
                    found = true;
                    sessionStorage.setItem('teacherUser', username);
                    sessionStorage.setItem('loginType', 'teacher');
                    
                    loginScreen.classList.add('hidden');
                    openStudentsSection();
                    showToast("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ " + username);
                }
            });
            
            if (!found) {
                errorDiv.textContent = "Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
                errorDiv.classList.remove('hidden');
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        })
        .catch(error => {
            errorDiv.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…";
            errorDiv.classList.remove('hidden');
            loginBtn.textContent = originalText;
            loginBtn.disabled = false;
            console.error("Firebase error:", error);
        });
}

function handleParentLogin(username, password, errorDiv, loginBtn, originalText) {
    db.ref('Parents').once('value')
        .then(snap => {
            let found = false;
            snap.forEach(p => {
                const data = p.val();
                if (data.name === username && data.password === password) {
                    found = true;
                    linkedStudentIdOfParent = data.studentId;
                    sessionStorage.setItem('parentUser', username);
                    sessionStorage.setItem('loginType', 'parent');
                    sessionStorage.setItem('linkedStudent', data.studentId);
                    
                    loginScreen.classList.add('hidden');
                    openStudentsSection();
                    showToast("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ " + username);
                }
            });
            
            if (!found) {
                errorDiv.textContent = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
                errorDiv.classList.remove('hidden');
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        })
        .catch(error => {
            errorDiv.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…";
            errorDiv.classList.remove('hidden');
            loginBtn.textContent = originalText;
            loginBtn.disabled = false;
        });
}

// ===================== Ø§Ù„Ø£Ø·ÙØ§Ù„ =====================
function openStudentsSection() {
    hideAllScreens();
    createOrShowScreen('studentsSection', createStudentsSectionHTML);
    loadStudents();
}

function createStudentsSectionHTML() {
    return `
        <div class="max-w-4xl mx-auto py-8 px-4">
            <div class="flex justify-between items-center mb-8 border-b pb-4">
                <button onclick="goBackToDashboard()" class="text-blue-600 font-bold bg-blue-50 px-4 py-2 rounded-xl">
                    â† Ø§Ù„Ø¹ÙˆØ¯Ø©
                </button>
                <h2 class="text-2xl font-black text-blue-600">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„</h2>
                ${sessionStorage.getItem('loginType') === 'admin' ? 
                    `<button onclick="openTrash()" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl font-bold border border-red-200">
                        ğŸ—‘ï¸ Ø§Ù„Ø³Ù„Ø©
                    </button>` : ''}
            </div>
            
            ${sessionStorage.getItem('loginType') === 'admin' ? `
            <div class="bg-slate-50 p-6 rounded-[2.5rem] mb-6 text-center border-2 border-dashed border-slate-300">
                <input type="text" id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„ Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ" class="input-style mb-4 md:w-96">
                <button onclick="addStudent()" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 transition">
                    Ø¥Ø¶Ø§ÙØ© Ø·ÙÙ„ Ø¬Ø¯ÙŠØ¯ +
                </button>
            </div>
            ` : ''}
            
            <div class="max-w-md mx-auto mb-6 px-4">
                <input type="text" id="studentSearchInput" onkeyup="searchStudent()" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„..." 
                       class="w-full p-3 rounded-2xl border-2 border-blue-100 outline-none text-center font-bold">
            </div>
            
            <div id="studentsList" class="grid grid-cols-2 md:grid-cols-3 gap-6"></div>
        </div>
    `;
}

function loadStudents() {
    const studentsList = document.getElementById('studentsList');
    if (!studentsList) return;
    
    studentsList.innerHTML = '<div class="col-span-3"><div class="loading-spinner"></div></div>';
    
    db.ref('Students').on('value', snap => {
        studentsList.innerHTML = "";
        
        if (!snap.exists()) {
            studentsList.innerHTML = `
                <div class="col-span-3 text-center py-10">
                    <div class="text-5xl mb-4">ğŸ‘¶</div>
                    <h3 class="text-xl font-bold text-slate-600 mb-2">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·ÙØ§Ù„ Ù…Ø³Ø¬Ù„ÙŠÙ†</h3>
                    <p class="text-slate-400">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                </div>
            `;
            return;
        }
        
        const loginType = sessionStorage.getItem('loginType');
        const linkedStudent = sessionStorage.getItem('linkedStudent');
        
        snap.forEach(c => {
            if (loginType === 'parent' && c.key !== linkedStudent) return;
            
            const child = c.val();
            const card = document.createElement('div');
            card.className = "bg-white p-8 rounded-[2.5rem] shadow-sm font-black card-hover text-center border relative";
            
            let deleteBtn = '';
            if (loginType === 'admin') {
                deleteBtn = `<div class="del-btn" onclick="event.stopPropagation(); trashStudent('${c.key}','${child.name}')">X</div>`;
            }
            
            card.innerHTML = `
                ${deleteBtn}
                <div class="text-4xl mb-4">ğŸ‘¶</div>
                <h3 class="text-lg font-bold text-slate-700">${child.name}</h3>
            `;
            
            card.onclick = () => {
                sId = c.key;
                sName = child.name;
                openMonths();
            };
            
            studentsList.appendChild(card);
        });
    });
}

function addStudent() {
    const name = document.getElementById('newStudentName').value.trim();
    if (!name) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„", "error");
        return;
    }
    
    db.ref('Students').push({ 
        name: name,
        createdAt: new Date().getTime()
    })
    .then(() => {
        document.getElementById('newStudentName').value = "";
        showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·ÙÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    })
    .catch(error => {
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©", "error");
        console.error(error);
    });
}

// ===================== Ø§Ù„Ø´Ù‡ÙˆØ± =====================
function openMonths() {
    hideAllScreens();
    createOrShowScreen('monthsScreen', createMonthsScreenHTML);
    
    const monthsGrid = document.getElementById('monthsGrid');
    monthsGrid.innerHTML = "";
    
    const now = new Date();
    const currentMonthName = monthsArr[now.getMonth()];
    
    monthsArr.forEach(month => {
        const monthCard = document.createElement('div');
        monthCard.className = "month-card";
        
        if (month === currentMonthName) {
            monthCard.classList.add('current');
            monthCard.innerHTML = `
                <div class="text-3xl mb-2">ğŸ“…</div>
                <h3 class="text-xl font-bold">${month}</h3>
                <p class="text-sm opacity-90">(Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ)</p>
            `;
        } else {
            monthCard.classList.add('future');
            monthCard.innerHTML = `
                <div class="text-3xl mb-2">ğŸ“…</div>
                <h3 class="text-xl font-bold">${month}</h3>
            `;
        }
        
        monthCard.onclick = () => {
            mName = month;
            openChoiceScreen();
        };
        
        monthsGrid.appendChild(monthCard);
    });
}

function createMonthsScreenHTML() {
    return `
        <div class="max-w-4xl mx-auto py-8 px-4">
            <button onclick="goBackToStudents()" class="mb-8 text-blue-600 font-bold float-right bg-blue-50 px-4 py-2 rounded-xl">
                â† Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø£Ø·ÙØ§Ù„
            </button>
            
            <h2 class="text-3xl font-black mb-10 text-blue-600 text-center">${sName}</h2>
            <p class="text-slate-500 text-center mb-10">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¹Ø±Ø¶Ù‡</p>
            
            <div id="monthsGrid" class="grid grid-cols-3 md:grid-cols-4 gap-4"></div>
        </div>
    `;
}

// ===================== Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± =====================
function openChoiceScreen() {
    hideAllScreens();
    createOrShowScreen('choiceScreen', createChoiceScreenHTML);
}

function createChoiceScreenHTML() {
    return `
        <div class="max-w-4xl mx-auto py-8 px-4">
            <button onclick="goBackToMonths()" class="mb-10 text-blue-600 font-bold float-right bg-blue-50 px-4 py-2 rounded-xl">
                â† Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø´Ù‡ÙˆØ±
            </button>
            
            <h2 class="text-3xl font-black mb-6 text-slate-800 text-center">${sName} - ${mName}</h2>
            <p class="text-slate-500 text-center mb-10">Ø§Ø®ØªØ± Ù…Ø§ ØªØ±ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 px-4">
                <div onclick="openSubjectsMenu()" class="bg-white p-12 shadow-2xl rounded-[3rem] border-t-8 border-orange-400 cursor-pointer hover:scale-105 transition">
                    <div class="text-6xl mb-4">ğŸ“‹</div>
                    <h3 class="text-2xl font-black text-orange-500">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h3>
                    <p class="text-slate-500 mt-2">Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</p>
                </div>
                
                <div onclick="openDaysScreen()" class="bg-white p-12 shadow-2xl rounded-[3rem] border-t-8 border-blue-500 cursor-pointer hover:scale-105 transition">
                    <div class="text-6xl mb-4">ğŸ“Š</div>
                    <h3 class="text-2xl font-black text-blue-600">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                    <p class="text-slate-500 mt-2">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
                </div>
                
                <div onclick="openScheduleScreen()" class="bg-white p-12 shadow-2xl rounded-[3rem] border-t-8 border-emerald-500 cursor-pointer hover:scale-105 transition">
                    <div class="text-6xl mb-4">ğŸ“…</div>
                    <h3 class="text-2xl font-black text-emerald-600">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                    <p class="text-slate-500 mt-2">Ø§Ù„Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ</p>
                </div>
            </div>
        </div>
    `;
}

// ===================== Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© =====================
function openSubjectsMenu() {
    hideAllScreens();
    createOrShowScreen('subjectsMenu', createSubjectsMenuHTML);
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆÙ„ÙŠ Ø£Ù…Ø±ØŒ Ù†ÙØªØ­ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
    if (sessionStorage.getItem('loginType') === 'parent') {
        openParentSubjectsView();
        return;
    }
}

function createSubjectsMenuHTML() {
    const subjects = [
        { name: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', color: '#ef4444', icon: 'ğŸ“–' },
        { name: 'English', color: '#3b82f6', icon: 'ğŸ”¤' },
        { name: 'Math', color: '#10b981', icon: 'ğŸ”¢' },
        { name: 'Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¯ÙŠÙ†ÙŠØ©', color: '#f59e0b', icon: 'ğŸŒ™' },
        { name: 'Montessori', color: '#8b5cf6', icon: 'ğŸ§©' },
        { name: 'Ù‚Ø±Ø¢Ù† Ø¥Ø¶Ø§ÙÙŠ', color: '#047857', icon: 'ğŸ•Œ' },
        { name: 'Ù…Ù†Ø§Ø³Ø¨Ø§Øª', color: '#db2777', icon: 'ğŸ‰' },
        { name: 'ØªÙ†Ù…ÙŠØ© Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª', color: '#6366f1', icon: 'ğŸ¨' }
    ];
    
    let subjectsHTML = '';
    subjects.forEach(subject => {
        subjectsHTML += `
            <div onclick="openGoalEntry('${subject.name}', '${subject.color}', '${subject.icon}')" 
                 class="subject-card" style="background: ${subject.color}">
                <div class="text-4xl mb-3">${subject.icon}</div>
                <h3 class="text-xl font-bold">${subject.name}</h3>
            </div>
        `;
    });
    
    return `
        <div class="max-w-4xl mx-auto py-8 px-4">
            <button onclick="goBackToChoice()" class="mb-8 text-blue-600 font-bold float-right bg-blue-50 px-4 py-2 rounded-xl">
                â† Ø±Ø¬ÙˆØ¹
            </button>
            
            <h2 class="text-3xl font-black mb-10 text-slate-800 text-center">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h2>
            <p class="text-slate-500 text-center mb-10">${sName} - ${mName}</p>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                ${subjectsHTML}
            </div>
            
            ${sessionStorage.getItem('loginType') === 'admin' ? `
            <div class="mt-10 text-center">
                <button onclick="exportMonthlyPlan()" class="bg-slate-800 text-white px-8 py-4 rounded-2xl font-bold hover:bg-black transition">
                    ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
                </button>
            </div>
            ` : ''}
        </div>
    `;
}

// ===================== Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù =====================
function openGoalEntry(subject, color, icon) {
    currentSub = subject;
    hideAllScreens();
    createOrShowScreen('goalEntryScreen', createGoalEntryScreenHTML(subject, color, icon));
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„Ø®Ù„ÙÙŠØ©
    const header = document.getElementById('entryHeader');
    if (header) header.style.background = color;
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    loadGoals();
}

function createGoalEntryScreenHTML(subject, color, icon) {
    const isParent = sessionStorage.getItem('loginType') === 'parent';
    
    return `
        <div class="max-w-2xl mx-auto py-8 px-4">
            <button onclick="goBackToSubjects()" class="mb-8 text-white font-bold float-right px-4 py-2 rounded-xl" style="background: ${color}">
                â† Ø±Ø¬ÙˆØ¹
            </button>
            
            <div id="entryHeader" class="p-8 rounded-[2rem] text-white text-center mb-8 shadow-xl" style="background: ${color}">
                <div class="text-4xl mb-4">${icon}</div>
                <h2 id="entryTitle" class="text-2xl font-black">${subject}</h2>
                <p class="opacity-90">${sName} - ${mName}</p>
            </div>
            
            <div id="goalsContainer" class="mb-8">
                <div id="noGoalsMessage" class="p-10 bg-slate-50 rounded-[2rem] border-2 border-dashed border-slate-200 text-slate-400 font-bold text-center">
                    <div class="text-4xl mb-4">ğŸ“</div>
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‡Ø¯Ø§Ù Ù…Ø¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹
                </div>
                <div id="goalsListContainer" class="space-y-4"></div>
            </div>
            
            ${!isParent ? `
            <button onclick="showGoalForm()" class="w-full p-5 bg-blue-600 text-white rounded-2xl font-bold shadow-lg hover:bg-blue-700 transition mb-6">
                + Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯
            </button>
            
            <div id="goalInputForm" class="hidden p-6 bg-white border-2 border-blue-500 rounded-[2rem] shadow-2xl">
                <h3 class="text-lg font-black text-blue-600 mb-4 text-center">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯</h3>
                
                <input type="text" id="goalName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù Ø£Ùˆ Ø§Ù„Ù†Ø´Ø§Ø·" class="input-style">
                
                ${subject !== 'Ù…Ù†Ø§Ø³Ø¨Ø§Øª' ? `
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-right text-sm font-bold text-slate-500 mb-2">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²:</label>
                        <select id="goalScore" class="input-style">
                            ${Array.from({length: 11}, (_, i) => i * 10)
                                .map(n => `<option value="${n}">${n}%</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-right text-sm font-bold text-slate-500 mb-2">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©:</label>
                        <select id="helpLevel" class="input-style">
                            <option value="Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§Ø¹Ø¯Ø©">Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§Ø¹Ø¯Ø©</option>
                            <option value="Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¨Ø³ÙŠØ·Ø©">Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¨Ø³ÙŠØ·Ø©</option>
                            <option value="Ù…Ø³Ø§Ø¹Ø¯Ø© ÙƒØ¨ÙŠØ±Ø©">Ù…Ø³Ø§Ø¹Ø¯Ø© ÙƒØ¨ÙŠØ±Ø©</option>
                        </select>
                    </div>
                </div>
                ` : ''}
                
                <div class="flex gap-2 mt-6">
                    <button onclick="saveGoal()" class="flex-1 p-4 bg-emerald-500 text-white rounded-xl font-bold">Ø­ÙØ¸ âœ…</button>
                    <button onclick="hideGoalForm()" class="flex-1 p-4 bg-slate-100 text-slate-500 rounded-xl font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
            ` : ''}
        </div>
    `;
}

function loadGoals() {
    const container = document.getElementById('goalsListContainer');
    const msg = document.getElementById('noGoalsMessage');
    if (!container || !msg) return;
    
    db.ref(`MonthlyPlans/${sId}/${mName}/${currentSub}`).on('value', snapshot => {
        container.innerHTML = "";
        const data = snapshot.val();
        
        if (!data) {
            msg.classList.remove('hidden');
            return;
        }
        
        msg.classList.add('hidden');
        const isParent = sessionStorage.getItem('loginType') === 'parent';
        
        Object.entries(data).forEach(([key, goal]) => {
            const div = document.createElement('div');
            div.className = "bg-white p-4 rounded-2xl shadow-sm border-r-4 flex justify-between items-center";
            div.style.borderRightColor = currentSub === 'Ù…Ù†Ø§Ø³Ø¨Ø§Øª' ? '#db2777' : '#3b82f6';
            
            let goalInfo = `<div><span class="font-bold text-slate-700">${goal.name}</span>`;
            if (currentSub !== 'Ù…Ù†Ø§Ø³Ø¨Ø§Øª' && goal.score && goal.help) {
                goalInfo += `<br><span class="text-xs text-blue-500 font-bold">${goal.score} - ${goal.help}</span>`;
            }
            goalInfo += `</div>`;
            
            let actionButtons = '';
            if (!isParent) {
                actionButtons = `
                    <div class="flex gap-2">
                        <button onclick="editGoal('${key}', '${goal.name}', '${goal.score || ''}', '${goal.help || ''}')" 
                                class="text-blue-500 text-sm font-bold px-3 py-1 bg-blue-50 rounded-lg">
                            ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button onclick="deleteGoal('${key}')" 
                                class="text-red-500 text-sm font-bold px-3 py-1 bg-red-50 rounded-lg">
                            Ø­Ø°Ù
                        </button>
                    </div>
                `;
            }
            
            div.innerHTML = `${actionButtons}${goalInfo}`;
            container.appendChild(div);
        });
    });
}

function showGoalForm() {
    document.getElementById('goalInputForm').classList.remove('hidden');
}

function hideGoalForm() {
    document.getElementById('goalInputForm').classList.add('hidden');
    document.getElementById('goalName').value = "";
}

function saveGoal() {
    const name = document.getElementById('goalName').value.trim();
    if (!name) {
        showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù", "error");
        return;
    }
    
    let goalData = {
        name: name,
        timestamp: new Date().getTime()
    };
    
    if (currentSub !== 'Ù…Ù†Ø§Ø³Ø¨Ø§Øª') {
        goalData.score = document.getElementById('goalScore').value + "%";
        goalData.help = document.getElementById('helpLevel').value;
    }
    
    let ref;
    if (editingGoalId) {
        ref = db.ref(`MonthlyPlans/${sId}/${mName}/${currentSub}/${editingGoalId}`);
    } else {
        ref = db.ref(`MonthlyPlans/${sId}/${mName}/${currentSub}`).push();
    }
    
    ref.set(goalData)
    .then(() => {
        showToast(editingGoalId ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡Ø¯Ù âœ¨" : "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø¯Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        editingGoalId = null;
        hideGoalForm();
        document.getElementById('goalName').value = "";
    })
    .catch(error => {
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸", "error");
        console.error(error);
    });
}

function editGoal(id, name, score, help) {
    editingGoalId = id;
    showGoalForm();
    document.getElementById('goalName').value = name;
    
    if (currentSub !== 'Ù…Ù†Ø§Ø³Ø¨Ø§Øª') {
        if (score) document.getElementById('goalScore').value = score.replace('%', '');
        if (help) document.getElementById('helpLevel').value = help;
    }
}

function deleteGoal(id) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø¯ÙØŸ")) return;
    
    db.ref(`MonthlyPlans/${sId}/${mName}/${currentSub}/${id}`).remove()
    .then(() => {
        showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‡Ø¯Ù Ø¨Ù†Ø¬Ø§Ø­ ğŸ—‘ï¸");
    })
    .catch(error => {
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù", "error");
    });
}

// ===================== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© =====================
function openDaysScreen() {
    hideAllScreens();
    createOrShowScreen('daysScreen', createDaysScreenHTML);
    loadDays();
}

function createDaysScreenHTML() {
    return `
        <div class="max-w-4xl mx-auto py-8 px-4">
            <button onclick="goBackToChoice()" class="mb-8 text-blue-600 font-bold float-right bg-blue-50 px-4 py-2 rounded-xl">
                â† Ø±Ø¬ÙˆØ¹
            </button>
            
            <h2 class="text-3xl font-black mb-6 text-slate-800 text-center">${sName} - ${mName}</h2>
            <p class="text-slate-500 text-center mb-10">Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… Ù„Ø¹Ø±Ø¶ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</p>
            
            <div id="daysGrid" class="grid grid-cols-5 md:grid-cols-7 gap-3"></div>
        </div>
    `;
}

function loadDays() {
    const daysGrid = document.getElementById('daysGrid');
    if (!daysGrid) return;
    
    daysGrid.innerHTML = "";
    
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonthIdx = now.getMonth();
    const currentDay = now.getDate();
    const monthIdx = monthsArr.indexOf(mName);
    
    // Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    db.ref(`DailyReports/${sId}`).once('value').then(snap => {
        const reportsData = snap.val() || {};
        
        for (let day = 1; day <= 31; day++) {
            const dateCheck = new Date(currentYear, monthIdx, day);
            if (dateCheck.getMonth() !== monthIdx) break;
            
            const dayOfWeek = dateCheck.getDay();
            if (dayOfWeek === 5 || dayOfWeek === 6) continue; // ØªØ®Ø·ÙŠ Ø§Ù„Ø¬Ù…Ø¹Ø© ÙˆØ§Ù„Ø³Ø¨Øª
            
            const reportDate = `${currentYear}-${(monthIdx + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            const hasReport = reportsData[reportDate] !== undefined;
            const isToday = (currentYear === currentYear && monthIdx === currentMonthIdx && day === currentDay);
            const isPast = (dateCheck < new Date(currentYear, currentMonthIdx, currentDay));
            
            const dayCard = document.createElement('div');
            dayCard.className = "day-card";
            
            if (isToday) {
                dayCard.classList.add('today');
                dayCard.innerHTML = `${day}<br><span class="text-xs">Ø§Ù„ÙŠÙˆÙ…</span>`;
            } else if (hasReport) {
                dayCard.classList.add('has-report');
                dayCard.innerHTML = `${day}<br><span class="text-xs">âœ…</span>`;
            } else if (isPast) {
                dayCard.classList.add('no-report');
                dayCard.innerHTML = `${day}<br><span class="text-xs">âš ï¸</span>`;
            } else {
                dayCard.classList.add('future');
                dayCard.textContent = day;
            }
            
            dayCard.onclick = () => {
                selectedDay = day;
                if (sessionStorage.getItem('loginType') === 'parent') {
                    openParentDailyReport();
                } else {
                    openFollowUpScreen();
                }
            };
            
            daysGrid.appendChild(dayCard);
        }
    });
}

// ===================== Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© =====================
function openFollowUpScreen() {
    hideAllScreens();
    createOrShowScreen('followUpScreen', createFollowUpScreenHTML);
    loadFollowUpData();
}

function createFollowUpScreenHTML() {
    const isParent = sessionStorage.getItem('loginType') === 'parent';
    
    return `
        <div class="max-w-2xl mx-auto py-8 px-4">
            <button onclick="goBackToDays()" class="mb-8 text-blue-600 font-bold float-right bg-blue-50 px-4 py-2 rounded-xl">
                â† Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø£ÙŠØ§Ù…
            </button>
            
            <div class="bg-white rounded-[2.5rem] shadow-xl p-6 border-t-8 border-blue-600">
                <h2 class="text-2xl font-black text-center mb-2 text-blue-600">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ… ${selectedDay} ${mName}</h2>
                <p id="reportDateDisplay" class="text-center text-slate-400 font-bold mb-6 text-sm">${sName}</p>
                
                <div class="follow-up-box">
                    <h3 class="section-title text-purple-600">ğŸ­ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ø¬ÙŠØ©</h3>
                    <div class="flex justify-around items-center py-4">
                        <div onclick="setMood('happy', this)" class="mood-btn">ğŸ¤©</div>
                        <div onclick="setMood('angry', this)" class="mood-btn">ğŸ˜¡</div>
                        <div onclick="setMood('sad', this)" class="mood-btn">ğŸ˜¢</div>
                        <div onclick="setMood('naughty', this)" class="mood-btn">ğŸ¤ª</div>
                    </div>
                </div>

                <div class="follow-up-box">
                    <h3 class="section-title text-sky-600">ğŸ˜´ Ø§Ù„Ù‚ÙŠÙ„ÙˆÙ„Ø©</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="time" id="nap_from" class="input-style" ${isParent ? 'disabled' : ''}>
                        <input type="time" id="nap_to" class="input-style" ${isParent ? 'disabled' : ''}>
                    </div>
                </div>

                <div class="follow-up-box">
                    <h3 class="section-title text-blue-500">ğŸš½ Ø§Ù„Ø­Ù…Ø§Ù…</h3>
                    <select id="potty_status" class="input-style" ${isParent ? 'disabled' : ''}>
                        <option value="Ù†Ø¸ÙŠÙ">Ù†Ø¸ÙŠÙ</option>
                        <option value="ØªØºÙŠÙŠØ± Ø­ÙØ§Ø¶">ØªØºÙŠÙŠØ± Ø­ÙØ§Ø¶</option>
                        <option value="Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø­Ù…Ø§Ù…">Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø­Ù…Ø§Ù…</option>
                    </select>
                </div>

                <div class="follow-up-box">
                    <h3 class="section-title text-pink-600">ğŸ¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</h3>
                    <div id="activitiesGrid" class="grid grid-cols-2 gap-2 text-sm"></div>
                </div>

                <div class="follow-up-box">
                    <h3 class="section-title text-orange-500">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
                    <textarea id="daily_notes" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..." 
                              class="input-style h-24 resize-none p-4 text-right border" ${isParent ? 'disabled' : ''}></textarea>
                </div>

                ${!isParent ? `
                <button onclick="saveDailyReport()" class="w-full p-6 bg-blue-600 text-white rounded-3xl font-bold shadow-lg hover:bg-blue-700 transition mt-6">
                    Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± âœ…
                </button>
                ` : ''}
            </div>
        </div>
    `;
}

function loadFollowUpData() {
    const year = 2026;
    const monthIdx = monthsArr.indexOf(mName);
    const reportDate = `${year}-${(monthIdx + 1).toString().padStart(2, '0')}-${selectedDay.toString().padStart(2, '0')}`;
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ù†Ø´Ø·Ø©
    const activitiesGrid = document.getElementById('activitiesGrid');
    if (activitiesGrid) {
        activitiesGrid.innerHTML = activitiesList.map(act => `
            <label class="activity-check">
                <span>${act}</span>
                <input type="checkbox" class="activity-checkbox" value="${act}" 
                       ${sessionStorage.getItem('loginType') === 'parent' ? 'disabled' : ''}>
            </label>
        `).join('');
    }
    
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù† ÙˆØ¬Ø¯Øª
    db.ref(`DailyReports/${sId}/${reportDate}`).once('value').then(snap => {
        const data = snap.val() || {};
        
        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
        if (data.nap_from) document.getElementById('nap_from').value = data.nap_from;
        if (data.nap_to) document.getElementById('nap_to').value = data.nap_to;
        if (data.potty_status) document.getElementById('potty_status').value = data.potty_status;
        if (data.notes) document.getElementById('daily_notes').value = data.notes;
        if (data.mood) setMood(data.mood);
        
        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø©
        if (data.activities) {
            data.activities.forEach(activity => {
                const checkbox = document.querySelector(`.activity-checkbox[value="${activity}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
    });
}

function setMood(mood, element) {
    if (sessionStorage.getItem('loginType') === 'parent') return;
    
    selectedMood = mood;
    document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('active'));
    if (element) element.classList.add('active');
}

function saveDailyReport() {
    const year = 2026;
    const monthIdx = monthsArr.indexOf(mName);
    const reportDate = `${year}-${(monthIdx + 1).toString().padStart(2, '0')}-${selectedDay.toString().padStart(2, '0')}`;
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    const selectedActivities = [];
    document.querySelectorAll('.activity-checkbox:checked').forEach(cb => {
        selectedActivities.push(cb.value);
    });
    
    const reportData = {
        mood: selectedMood,
        nap_from: document.getElementById('nap_from').value,
        nap_to: document.getElementById('nap_to').value,
        potty_status: document.getElementById('potty_status').value,
        activities: selectedActivities,
        notes: document.getElementById('daily_notes').value,
        timestamp: new Date().getTime(),
        studentName: sName,
        month: mName,
        day: selectedDay
    };
    
    db.ref(`DailyReports/${sId}/${reportDate}`).update(reportData)
    .then(() => {
        showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        openDaysScreen();
    })
    .catch(error => {
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±", "error");
        console.error(error);
    });
}

// ===================== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„ =====================
function hideAllScreens() {
    document.querySelectorAll('.admin-page').forEach(el => el.classList.add('hidden'));
}

function createOrShowScreen(screenId, htmlGenerator) {
    let screen = document.getElementById(screenId);
    
    if (!screen) {
        screen = document.createElement('div');
        screen.id = screenId;
        screen.className = 'admin-page hidden';
        screen.innerHTML = htmlGenerator();
        document.body.appendChild(screen);
    } else {
        screen.innerHTML = htmlGenerator();
    }
    
    screen.classList.remove('hidden');
}

function goBackToDashboard() {
    hideAllScreens();
    dashboard.classList.remove('hidden');
}

function goBackToStudents() {
    hideAllScreens();
    openStudentsSection();
}

function goBackToMonths() {
    hideAllScreens();
    openMonths();
}

function goBackToChoice() {
    hideAllScreens();
    openChoiceScreen();
}

function goBackToSubjects() {
    hideAllScreens();
    openSubjectsMenu();
}

function goBackToDays() {
    hideAllScreens();
    openDaysScreen();
}

// ===================== Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© =====================
function searchStudent() {
    const query = document.getElementById('studentSearchInput').value.toLowerCase();
    const cards = document.querySelectorAll('#studentsList > div');
    
    cards.forEach(card => {
        const name = card.textContent.toLowerCase();
        card.style.display = name.includes(query) ? "block" : "none";
    });
}

function trashStudent(id, name) {
    if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ ${name} Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©ØŸ`)) return;
    
    db.ref('Students/' + id).once('value')
        .then(snap => {
            const data = snap.val();
            data.deletedAt = new Date().getTime();
            return db.ref('TrashBin/Students/' + id).set(data);
        })
        .then(() => db.ref('Students/' + id).remove())
        .then(() => showToast("ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø·ÙÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©"))
        .catch(error => {
            showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‚Ù„", "error");
            console.error(error);
        });
}

function openTrash() {
    showToast("ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±", "info");
}

function exportMonthlyPlan() {
    showToast("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ...", "info");
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ù‡Ù†Ø§
}

function openScheduleScreen() {
    showToast("Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±", "info");
}

function openParentDailyReport() {
    showToast("Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±", "info");
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¶ Ù„Ù„Ø¢Ø¨Ø§Ø¡
}

function openParentSubjectsView() {
    showToast("Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù„Ù„Ø¢Ø¨Ø§Ø¡", "info");
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¶ Ù„Ù„Ø¢Ø¨Ø§Ø¡
}

// ===================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====================
function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    
    const bg = type === 'success' ? 'bg-emerald-600' : 
               type === 'error' ? 'bg-red-600' : 
               type === 'info' ? 'bg-blue-600' : 'bg-slate-600';
    
    const icon = type === 'success' ? 'âœ…' : 
                 type === 'error' ? 'âš ï¸' : 
                 type === 'info' ? 'â„¹ï¸' : 'ğŸ’¡';
    
    toast.className = `${bg} text-white px-6 py-4 rounded-2xl shadow-2xl toast flex items-center font-bold`;
    toast.innerHTML = `<span class="text-xl">${icon}</span> <span>${message}</span>`;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('toast-fade-out');
        setTimeout(() => toast.remove(), 500);
    }, 3000);
}

// ===================== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ =====================
function logout() {
    sessionStorage.clear();
    hideAllScreens();
    mainScreen.classList.remove('hidden');
    showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
}

// ===================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© =====================
document.addEventListener('DOMContentLoaded', function() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù„Ø³Ø© Ø³Ø§Ø¨Ù‚Ø©
    const loginType = sessionStorage.getItem('loginType');
    if (loginType) {
        mainScreen.classList.add('hidden');
        
        if (loginType === 'admin') {
            const adminUser = sessionStorage.getItem('adminUser');
            dashboard.classList.remove('hidden');
            document.getElementById('adminName').textContent = adminUser;
        } else {
            openStudentsSection();
        }
    }
});
</script>
</body>
</html>
