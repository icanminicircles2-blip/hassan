async function exportMonthlyPlanPDF() {
    showToast("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±... Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø© â³");

    try {
        const snapshot = await db.ref(`MonthlyPlans/${sId}/${mName}`).once('value');
        const planData = snapshot.val();

        if (!planData) {
            showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø© Ù…Ø³Ø¬Ù„Ø©!", "error");
            return;
        }

        const subjectStyles = {
            'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©': { color: '#ef4444', bg: '#fff5f5' },
            'English': { color: '#3b82f6', bg: '#f0f7ff' },
            'Math': { color: '#10b981', bg: '#f0fff4' },
            'Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¯ÙŠÙ†ÙŠØ©': { color: '#f59e0b', bg: '#fffaf0' },
            'Montessori': { color: '#8b5cf6', bg: '#f5f3ff' },
            'Ù‚Ø±Ø¢Ù† Ø¥Ø¶Ø§ÙÙŠ': { color: '#047857', bg: '#f0fdf4' },
            'Ù…Ù†Ø§Ø³Ø¨Ø§Øª': { color: '#db2777', bg: '#fff5f7' },
            'ØªÙ†Ù…ÙŠØ© Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª': { color: '#6366f1', bg: '#f5f7ff' }
        };

        // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø§ÙˆÙŠØ© ÙˆØªÙ†Ø³ÙŠÙ‚Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
        const element = document.createElement('div');
        element.style.width = '700px';
        element.style.padding = '30px';
        element.style.background = '#white';
        element.style.position = 'absolute';
        element.style.top = '-9999px';
        element.setAttribute('dir', 'rtl');
        element.style.fontFamily = 'Arial, sans-serif';

        let subjectsHTML = "";
        for (const [subject, goals] of Object.entries(planData)) {
            const style = subjectStyles[subject] || { color: '#444', bg: '#f9f9f9' };
            const cleanGoals = Array.isArray(goals) ? goals : Object.values(goals);
            
            let goalsList = cleanGoals.map(g => g.name ? `
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee; align-items:center;">
                    <span style="font-weight:bold; color:#333;">â€¢ ${g.name}</span>
                    <span style="color:${style.color}; font-weight:bold; font-size:12px;">[${g.help}] - ${g.score}</span>
                </div>` : "").join('');

            subjectsHTML += `
                <div style="margin-bottom:20px; border:2px solid ${style.color}; border-radius:15px; overflow:hidden; background:${style.bg};">
                    <div style="background:${style.color}; color:white; padding:10px; font-weight:bold; text-align:center; font-size:18px;">
                        ${subject}
                    </div>
                    <div style="padding:10px; background:white;">${goalsList}</div>
                </div>`;
        }

        element.innerHTML = `
            <div style="text-align:center; border-bottom:3px solid #1e40af; padding-bottom:20px; margin-bottom:20px;">
                <h1 style="color:#1e40af; font-size:35px; margin:0;">Many Circles</h1>
                <p style="font-size:18px; color:#666;">ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±: ${mName}</p>
                <p style="font-size:22px; font-weight:bold;">Ø§Ù„Ø¨Ø·Ù„: ${sName} â­</p>
                <p style="color:#0369a1; font-weight:bold; margin-top:10px;">ÙØ®ÙˆØ±ÙŠÙ† Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø¯Ù… ğŸŒŸ</p>
            </div>
            ${subjectsHTML}
            <p style="text-align:center; color:#999; margin-top:30px;">ØµÙ†Ø¹ Ø¨ÙƒÙ„ Ø­Ø¨ ÙÙŠ Many Circles â¤ï¸</p>
        `;

        document.body.appendChild(element);

        // 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… html2pdf Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€ Canvas Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØµÙØ­Ø§Øª Ø¨ÙŠØ¶Ø§Ø¡
        const opt = {
            margin: 10,
            filename: `Report_${sName}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2, 
                useCORS: true,
                letterRendering: true,
                scrollY: 0
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ÙØ¹Ù„ÙŠ
        await html2pdf().set(opt).from(element).save();

        // 3. ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙØ­Ø©
        document.body.removeChild(element);
        showToast("ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! âœ…");

    } catch (e) {
        console.error("PDF Error: ", e);
        showToast("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµÙ…ÙŠÙ…", "error");
    }
}
